---
name: Wiki Documentation Sync

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'scripts/generate_wiki_docs.py'
  workflow_dispatch: {}

jobs:
  update-wiki:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install poetry
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry install
          
      - name: Generate Wiki Documentation
        run: |
          poetry run python scripts/generate_wiki_docs.py
          
      - name: Checkout Wiki Repository
        run: |
          git config --global user.name 'JARVYS_DEV Auto-Doc'
          git config --global user.email 'github-actions@github.com'
          REPO="${{ github.repository }}"
          git clone \
            https://x-access-token:${GH_TOKEN}@github.com/${REPO}.wiki.git \
            wiki-repo
            
      - name: Update Wiki Content
        run: |
          # Copier les fichiers gÃ©nÃ©rÃ©s vers le wiki
          cp wiki/Home.md wiki-repo/Home.md
          cp wiki/API-Reference.md wiki-repo/API-Reference.md
          
          # CrÃ©er une page de changelog automatique
          cd wiki-repo
          echo "# ðŸ“ Changelog Documentation" > Changelog.md
          echo "" >> Changelog.md
          echo "*Mise Ã  jour automatique le $(date '+%d/%m/%Y Ã  %H:%M')*" >> Changelog.md
          echo "" >> Changelog.md
          echo "## DerniÃ¨res modifications" >> Changelog.md
          echo "" >> Changelog.md
          echo "- Documentation gÃ©nÃ©rÃ©e automatiquement depuis le code source" >> Changelog.md
          echo "- Commit: ${{ github.sha }}" >> Changelog.md
          echo "- Branche: ${{ github.ref_name }}" >> Changelog.md
          
      - name: Commit and Push to Wiki
        run: |
          cd wiki-repo
          git add .
          if git diff --staged --quiet; then
            echo "Aucune modification dÃ©tectÃ©e dans la documentation"
          else
            git commit -m "ðŸ¤– Auto-update documentation from ${{ github.ref_name }} @ ${{ github.sha }}"
            git push
            echo "âœ… Documentation Wiki mise Ã  jour automatiquement"
          fi
