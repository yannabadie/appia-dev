name: ğŸš€ Early Launch Issues Setup Automation

"on":
  workflow_dispatch:
    inputs:
      mode:
        description: "Early launch mode"
        required: true
        default: "process_backlog"
        type: choice
        options:
          - process_backlog
          - priority_check
          - monitor_status
  schedule:
    # Run every 30 minutes for autonomous processing
    - cron: "*/30 * * * *"
  push:
    branches: [main]
    paths:
      - '.github/workflows/early-launch-issues.yml'
      - 'scripts/issue_processor.py'

env:
  AGENT_NAME: "JARVYS_DEV_EARLY_LAUNCH"
  ENVIRONMENT: "cloud"

jobs:
  trigger-jarvys-autonomous:
    name: ğŸŒ©ï¸ Trigger JARVYS Autonomous Mode
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'process_backlog' || github.event_name == 'schedule'

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸš€ Trigger JARVYS Cloud Deployment
        run: |
          echo "ğŸš€ Triggering JARVYS Cloud Deployment in autonomous mode..."
          curl -X POST \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/jarvys-cloud.yml/dispatches \
            -d '{"ref":"main","inputs":{"mode":"autonomous"}}'
          echo "âœ… JARVYS autonomous mode dispatch sent"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: ğŸ“ Log Autonomous Trigger
        run: |
          echo "ğŸ“ Log Autonomous Trigger"
          echo "ğŸš€ JARVYS Autonomous mode triggered at $(date)"
          echo "Next scheduled run: 30 minutes"

  process-issue-backlog:
    name: ğŸ“‹ Process Issue Backlog
    runs-on: ubuntu-latest
    needs: [trigger-jarvys-autonomous]
    if: always() && (github.event.inputs.mode == 'process_backlog' || github.event_name == 'schedule')

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install poetry
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry install --with dev --no-interaction

      - name: ğŸ“‹ Process Priority Issues
        run: |
          echo "ğŸ” Processing priority issues..."
          poetry run python scripts/issue_processor.py --mode priority
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO: ${{ github.repository }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: ğŸ“Š Update Dashboard Progress
        run: |
          echo "ğŸ“Š Updating Supabase dashboard with progress..."
          poetry run python scripts/issue_processor.py --mode dashboard_update
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

  monitor-early-launch:
    name: ğŸ“ˆ Monitor Early Launch Status
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'monitor_status' || github.event_name == 'schedule'

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install poetry
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry install --no-interaction

      - name: ğŸ“ˆ Generate Status Report
        run: |
          echo "ğŸ“ˆ Generating early launch status report..."
          poetry run python scripts/issue_processor.py --mode status_report
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO: ${{ github.repository }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: ğŸ¯ Check Success Criteria
        run: |
          echo "ğŸ¯ Checking early launch success criteria..."
          echo "âœ… Workflow triggered successfully"
          echo "âœ… 30-minute cycle active"
          echo "ğŸ“Š Dashboard URL: https://kzcswopokvknxmxczilu.supabase.co"

  notification:
    name: ğŸ“¬ Early Launch Notifications
    runs-on: ubuntu-latest
    needs: [trigger-jarvys-autonomous, process-issue-backlog, monitor-early-launch]
    if: always()

    steps:
      - name: ğŸ“¬ Send Launch Status
        run: |
          echo "ğŸ“¬ Early Launch Status Summary:"
          echo "Trigger JARVYS: ${{ needs.trigger-jarvys-autonomous.result }}"
          echo "Process Backlog: ${{ needs.process-issue-backlog.result }}"
          echo "Monitor Status: ${{ needs.monitor-early-launch.result }}"
          echo "Time: $(date)"

          if [ "${{ needs.process-issue-backlog.result }}" = "success" ]; then
            echo "ğŸ‰ Issue processing successful!"
          else
            echo "âš ï¸ Issue processing needs attention"
          fi
