name: ğŸŒ©ï¸ JARVYS_DEV Cloud Deployment

on:
  push:
    branches: [ main, dev ]
  schedule:
    # ExÃ©cution autonome toutes les heures
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: "Mode d'exÃ©cution"
        required: true
        default: 'autonomous'
        type: choice
        options:
        - autonomous
        - analysis
        - memory_sync
        - dashboard_deploy

env:
  AGENT_NAME: "JARVYS_DEV"
  ENVIRONMENT: "cloud"
  
jobs:
  deploy-dashboard:
    name: ğŸ“Š DÃ©ployer Dashboard Supabase
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'dashboard_deploy' || github.event_name == 'push'
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: ï¿½ Test Authentication
      run: |
        echo "ğŸ” Test de l'authentification Supabase..."
        if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
          echo "âŒ SUPABASE_ACCESS_TOKEN manquant"
          exit 1
        fi
        if [ -z "$SUPABASE_PROJECT_ID" ]; then
          echo "âŒ SUPABASE_PROJECT_ID manquant"
          exit 1
        fi
        echo "âœ… Secrets disponibles"
        echo "ğŸ“‹ Version Supabase CLI: $(supabase --version)"
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        
    - name: ï¿½ğŸš€ Deploy Edge Functions
      run: |
        echo "ğŸš€ DÃ©ploiement des Edge Functions JARVYS..."
        
        # VÃ©rifier la configuration Supabase
        if [ ! -f "supabase/config.toml" ]; then
          echo "âŒ Fichier supabase/config.toml manquant"
          exit 1
        fi
        
        echo "âœ… Configuration Supabase trouvÃ©e"
        
        # CrÃ©er la fonction jarvys-dashboard si elle n'existe pas
        if [ ! -d "supabase/functions/jarvys-dashboard" ]; then
          echo "ï¿½ CrÃ©ation de la fonction jarvys-dashboard..."
          mkdir -p supabase/functions/jarvys-dashboard
          cat > supabase/functions/jarvys-dashboard/index.ts << 'EOF'
        import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

        serve(async (req) => {
          const url = new URL(req.url)
          
          // Basic routing
          if (url.pathname === '/api/health') {
            return new Response(
              JSON.stringify({ 
                status: "healthy",
                service: "JARVYS Dashboard",
                timestamp: new Date().toISOString(),
                version: "1.0.0"
              }),
              { 
                headers: { "Content-Type": "application/json" },
                status: 200 
              }
            )
          }
          
          // Default dashboard response
          return new Response(
            JSON.stringify({ 
              message: "ğŸš€ JARVYS Dashboard dÃ©ployÃ© avec succÃ¨s !",
              timestamp: new Date().toISOString(),
              status: "active",
              endpoints: {
                health: "/api/health",
                dashboard: "/"
              }
            }),
            { 
              headers: { "Content-Type": "application/json" },
              status: 200 
            }
          )
        })
        EOF
        fi
        
        echo "ğŸ“ Contenu des fonctions:"
        ls -la supabase/functions/
        
        # Authentification avec Supabase
        echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token
        
        # DÃ©ployer la fonction
        echo "ğŸš€ DÃ©ploiement de jarvys-dashboard..."
        supabase functions deploy jarvys-dashboard --project-ref "$SUPABASE_PROJECT_ID" --debug
        
        echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

  autonomous-agent:
    name: ğŸ¤– Agent Autonome Cloud  
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'autonomous' || github.event_name == 'schedule' || github.event_name == 'push'
    
    steps:
    - name: ğŸ”„ Checkout Repository  
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ğŸ“¦ Install Basic Dependencies
      run: |
        pip install poetry requests
        # Test if poetry.lock exists
        if [ -f "poetry.lock" ]; then
          echo "ğŸ“‹ Installing from poetry.lock..."
          poetry install --only main --no-dev
        else
          echo "âš ï¸ poetry.lock not found, installing basic requirements..."
          [ -f "requirements.txt" ] && pip install -r requirements.txt || echo "No requirements.txt found"
        fi
        
    - name: ğŸ” Validate Environment
      run: |
        echo "ğŸ” Validation de l'environnement cloud pour JARVYS_DEV"
        python -c "
        import os
        required = ['OPENAI_API_KEY', 'GITHUB_TOKEN', 'SUPABASE_URL', 'SUPABASE_KEY', 'GEMINI_API_KEY']
        missing = [var for var in required if not os.getenv(var)]
        if missing:
            print(f'âŒ Variables manquantes: {missing}')
            exit(1)
        print('âœ… Toutes les variables d\'environnement sont dÃ©finies')
        print('ğŸš€ Environment validated successfully!')
        "
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
        
    - name: ğŸ§ª Basic Python Test
      run: |
        echo "ğŸ§ª Test Python de base..."
        python -c "
        import sys, os, json
        from datetime import datetime
        
        print(f'ğŸ Python version: {sys.version}')
        print(f'ğŸ“ Current directory: {os.getcwd()}')
        print(f'ï¿½ Environment vars: {len([k for k in os.environ.keys() if not k.startswith(\"_\")])} variables')
        print(f'â° Timestamp: {datetime.now().isoformat()}')
        print('âœ… Basic Python test passed!')
        "
        
    - name: ï¿½ Simple Metrics Log
      if: always()
      run: |
        echo "ğŸ“Š Logging simple metrics..."
        python -c "
        import os, json
        from datetime import datetime
        
        # Simple metrics
        metrics = {
            'agent_type': 'JARVYS_DEV',
            'event_type': 'basic_test',
            'service': 'github_actions',
            'success': True,
            'timestamp': datetime.now().isoformat(),
            'metadata': {
                'environment': 'cloud',
                'trigger': '${{ github.event_name }}',
                'run_id': '${{ github.run_id }}',
                'ref': '${{ github.ref }}'
            }
        }
        
        print(f'ğŸ“Š Metrics: {json.dumps(metrics, indent=2)}')
        print('âœ… Metrics generated successfully!')
        "
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

  memory-sync:
    name: ğŸ§  Synchronisation MÃ©moire
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'memory_sync' || github.event_name == 'schedule'
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install poetry
        poetry install --only main
        
    - name: ğŸ§  Sync Shared Memory
      run: |
        python -c "
        from src.jarvys_dev.tools.memory_infinite import get_memory
        import json
        
        print('ğŸ§  Synchronisation de la mÃ©moire partagÃ©e...')
        
        # MÃ©moire pour JARVYS_DEV
        memory_dev = get_memory('JARVYS_DEV', 'shared')
        
        # MÃ©moriser l'Ã©tat du repository
        memory_dev.memorize(
            f'Repository {\"${{ github.repository }}\"} mis Ã  jour le ${{ github.event.head_commit.timestamp }}',
            memory_type='knowledge',
            importance_score=0.6,
            tags=['repository', 'update', 'github']
        )
        
        # Stats de la mÃ©moire
        stats = memory_dev.get_memory_stats()
        print(f'ğŸ“Š Stats mÃ©moire: {json.dumps(stats, indent=2)}')
        "
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

  analysis:
    name: ğŸ” Analyse et Optimisation
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'analysis' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ğŸ“¦ Install Dependencies  
      run: |
        pip install poetry
        poetry install --with dev
        
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª ExÃ©cution des tests pour validation"
        poetry run pytest -v --tb=short
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        
    - name: ğŸ“Š Generate Analytics Report
      run: |
        python -c "
        from src.jarvys_dev.tools.memory_infinite import get_memory
        import json
        from datetime import datetime
        
        print('ğŸ“Š GÃ©nÃ©ration du rapport d\\'analyse...')
        
        memory = get_memory('JARVYS_DEV', 'analytics')
        
        # Analyser l'activitÃ© rÃ©cente
        recent_activity = memory.recall('github activity analysis', limit=20)
        
        # MÃ©moriser l'analyse
        analysis = f'''
        Analyse automatique du {datetime.now().strftime(\"%Y-%m-%d %H:%M\")}:
        - Repository: ${{ github.repository }}
        - Commit: ${{ github.sha }}
        - Tests: PassÃ©s avec succÃ¨s
        - MÃ©moire: {len(recent_activity)} activitÃ©s rÃ©centes analysÃ©es
        - Mode: Autonome cloud sur GitHub Actions
        '''
        
        memory.memorize(
            analysis,
            memory_type='knowledge',
            importance_score=0.8,
            tags=['analysis', 'automation', 'github_actions']
        )
        
        print('âœ… Rapport d\\'analyse mÃ©morisÃ©')
        "
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

  notify-completion:
    name: ğŸ“¢ Notification Fin d'ExÃ©cution
    runs-on: ubuntu-latest
    needs: [autonomous-agent, memory-sync, analysis]
    if: always()
    
    steps:
    - name: ğŸ“Š Create Summary Issue
      uses: actions/github-script@v7
      if: github.event_name == 'schedule' || github.event.inputs.mode == 'autonomous'
      with:
          script: |
            const now = new Date().toISOString();
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const title = `ğŸ¤– JARVYS_DEV - Rapport d'exÃ©cution autonome ${now.split('T')[0]}`;
            
            const body = `
            ## ğŸš€ Rapport d'ExÃ©cution Autonome JARVYS_DEV
            
            **ğŸ“… Date**: ${now}  
            **ğŸŒ©ï¸ Environnement**: Cloud (GitHub Actions)  
            **ğŸ”— Run**: [${context.runId}](${runUrl})  
            **âš¡ Trigger**: ${context.eventName}
            
            ### ğŸ“Š RÃ©sultats
            
            âœ… **Agent autonome**: ${{ needs.autonomous-agent.result }}  
            âœ… **Synchronisation mÃ©moire**: ${{ needs.memory-sync.result }}  
            âœ… **Analyse**: ${{ needs.analysis.result }}
            
            ### ğŸ§  MÃ©moire Infinie
            
            La mÃ©moire partagÃ©e entre JARVYS_DEV et JARVYS_AI a Ã©tÃ© mise Ã  jour avec les nouvelles expÃ©riences et connaissances acquises durant cette session.
            
            ### ğŸ“ˆ Dashboard
            
            Les mÃ©triques sont disponibles sur le dashboard auto-hÃ©bergÃ© Supabase.
            
            ---
            *GÃ©nÃ©rÃ© automatiquement par JARVYS_DEV en mode cloud*
            `;
            
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['from_jarvys_dev', 'autonomous-report', 'cloud']
              });
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
