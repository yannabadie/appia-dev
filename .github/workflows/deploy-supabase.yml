name: Deploy JARVYS Dashboard to Supabase

on:
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/**'
      - 'dashboard/**'
      - '.github/workflows/deploy-supabase.yml'
  workflow_dispatch:

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  deploy-edge-functions:
    runs-on: ubuntu-latest
    name: Deploy Edge Functions
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.37.x

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI installation
        run: supabase --version

      - name: Deploy Edge Functions
        run: |
          echo "🚀 Déploiement des Edge Functions JARVYS..."
          
          # Vérifier que les secrets sont présents
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "❌ SUPABASE_ACCESS_TOKEN non défini"
            exit 1
          fi
          
          if [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "❌ SUPABASE_PROJECT_ID non défini"
            exit 1
          fi
          
          # Lier le projet
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
          # Déployer les fonctions
          supabase functions deploy jarvys-dashboard
          
          echo "✅ Dashboard JARVYS déployé sur Supabase!"
          echo "🌐 URL: https://$SUPABASE_PROJECT_ID.functions.supabase.co/jarvys-dashboard"

      - name: Test deployment
        run: |
          # Attendre quelques secondes pour que le déploiement soit effectif
          sleep 10
          
          # Tester l'endpoint de status
          FUNCTION_URL="https://$SUPABASE_PROJECT_ID.functions.supabase.co/jarvys-dashboard/api/status"
          
          echo "🧪 Test de l'endpoint: $FUNCTION_URL"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$FUNCTION_URL")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "✅ Test réussi - Dashboard accessible"
          else
            echo "❌ Test échoué - Code de réponse: $RESPONSE"
            exit 1
          fi

      - name: Update deployment status
        if: success()
        run: |
          echo "📊 Mise à jour du statut de déploiement..."
          echo "Dashboard URL: https://$SUPABASE_PROJECT_ID.functions.supabase.co/jarvys-dashboard" >> $GITHUB_STEP_SUMMARY
          echo "API Status: https://$SUPABASE_PROJECT_ID.functions.supabase.co/jarvys-dashboard/api/status" >> $GITHUB_STEP_SUMMARY
          echo "Deployed at: $(date)" >> $GITHUB_STEP_SUMMARY

  notify-success:
    runs-on: ubuntu-latest
    needs: deploy-edge-functions
    if: success()
    
    steps:
      - name: Success notification
        run: |
          echo "🎉 JARVYS Dashboard déployé avec succès sur Supabase!"
          echo "🌐 URL principale: https://$SUPABASE_PROJECT_ID.functions.supabase.co/jarvys-dashboard"
          echo "📊 API Status: https://$SUPABASE_PROJECT_ID.functions.supabase.co/jarvys-dashboard/api/status"
