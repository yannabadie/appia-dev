name: Deploy JARVYS Dashboard to Supabase

on:
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/jarvys-dashboard/**'
      - 'supabase/config.toml'
      - 'dashboard/**'
      - '.github/workflows/deploy-dashboard.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy dashboard'
        required: false
        default: false
        type: boolean

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SPB_EDGE_FUNCTIONS: ${{ secrets.SPB_EDGE_FUNCTIONS }}

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest
    name: Deploy JARVYS Dashboard
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ”§ Install Supabase CLI
      run: |
        npm install -g supabase@latest
        supabase --version

    - name: ğŸ” Authenticate with Supabase
      run: |
        echo "$SUPABASE_ACCESS_TOKEN" | supabase auth login --token -

    - name: ğŸ“ Verify project structure
      run: |
        echo "ğŸ” VÃ©rification de la structure du projet..."
        ls -la supabase/functions/jarvys-dashboard/
        
        if [ ! -f "supabase/functions/jarvys-dashboard/index.ts" ]; then
          echo "âŒ Edge Function manquante"
          exit 1
        fi
        
        echo "âœ… Structure du projet valide"

    - name: ğŸš€ Deploy Edge Function
      run: |
        echo "ğŸ”„ DÃ©ploiement de l'Edge Function jarvys-dashboard..."
        
        supabase functions deploy jarvys-dashboard \
          --project-ref $SUPABASE_PROJECT_ID \
          --no-verify-jwt
        
        echo "âœ… DÃ©ploiement terminÃ©"

    - name: ğŸ”‘ Configure secrets
      run: |
        echo "ğŸ” Configuration des secrets..."
        
        if [ ! -z "$SPB_EDGE_FUNCTIONS" ]; then
          supabase secrets set SPB_EDGE_FUNCTIONS="$SPB_EDGE_FUNCTIONS" \
            --project-ref $SUPABASE_PROJECT_ID
          echo "âœ… Secret SPB_EDGE_FUNCTIONS configurÃ©"
        else
          echo "âš ï¸ Secret SPB_EDGE_FUNCTIONS non dÃ©fini"
        fi

    - name: ğŸ§ª Test deployment
      run: |
        echo "ğŸ§ª Test de l'Edge Function dÃ©ployÃ©e..."
        
        FUNCTION_URL="https://$SUPABASE_PROJECT_ID.supabase.co/functions/v1/jarvys-dashboard"
        
        # Test health check
        echo "Testing health endpoint..."
        curl -f "$FUNCTION_URL/health" || exit 1
        
        # Test API status
        echo "Testing API status..."
        curl -f "$FUNCTION_URL/api/status" || exit 1
        
        echo "âœ… Tests rÃ©ussis"

    - name: ğŸ“Š Deployment summary
      run: |
        echo "ğŸ‰ JARVYS Dashboard dÃ©ployÃ© avec succÃ¨s!"
        echo ""
        echo "ğŸŒ Dashboard URL:"
        echo "   https://$SUPABASE_PROJECT_ID.supabase.co/functions/v1/jarvys-dashboard"
        echo ""
        echo "ğŸ“š API Endpoints:"
        echo "   GET  /api/status    - System status"
        echo "   GET  /api/metrics   - Performance metrics"
        echo "   GET  /api/data      - Complete dashboard data"
        echo "   POST /api/chat      - Chat with JARVYS"
        echo "   GET  /health        - Health check"
        echo ""
        echo "ğŸ” Secrets configurÃ©s:"
        echo "   âœ… SPB_EDGE_FUNCTIONS"
        echo ""
        echo "ğŸ“ˆ Dashboard en ligne et opÃ©rationnel!"

    - name: ğŸ“ Create deployment comment
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const deploymentUrl = `https://${{ env.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/jarvys-dashboard`;
          
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `ğŸš€ **JARVYS Dashboard dÃ©ployÃ© avec succÃ¨s!**
            
            ğŸŒ **Dashboard:** [${deploymentUrl}](${deploymentUrl})
            
            ğŸ“Š **APIs disponibles:**
            - \`GET /api/status\` - Statut systÃ¨me
            - \`GET /api/metrics\` - MÃ©triques performance
            - \`GET /api/data\` - DonnÃ©es complÃ¨tes
            - \`POST /api/chat\` - Chat avec JARVYS
            - \`GET /health\` - Health check
            
            âœ… DÃ©ployÃ© sur Supabase Edge Functions`
          });

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: deploy-dashboard
    if: failure()
    steps:
    - name: ğŸ“§ Notify deployment failure
      run: |
        echo "âŒ Ã‰chec du dÃ©ploiement JARVYS Dashboard"
        echo "ğŸ” VÃ©rifiez les logs de l'action GitHub pour plus de dÃ©tails"
        # Ici vous pourriez ajouter une notification Slack, Discord, etc.
